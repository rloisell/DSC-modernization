@startuml Health Check Sequence
!theme plain
autonumber

actor "User / Admin" as User
participant "React SPA\n(Health.jsx)" as HealthPage
participant "TanStack Query\nuseHealthCheck" as Hook
participant "Axios" as HTTP
participant "ASP.NET Core\nMiddleware" as MW
participant "HealthCheckService" as HCS
participant "DatabaseHealthCheck\n(IHealthCheck)" as DBCheck
participant "IServiceScopeFactory" as ScopeFactory
participant "ApplicationDbContext" as DbCtx
database "MariaDB" as DB

== Page Load (auto-fetch) ==

User -> HealthPage : Navigate to /health
activate HealthPage

HealthPage -> Hook : useHealthCheck()\n{ refetchInterval: 30_000 }
activate Hook

Hook -> HTTP : GET /health/details
activate HTTP

HTTP -> MW : request
activate MW

MW -> HCS : RunAsync(ct)
activate HCS

HCS -> DBCheck : CheckHealthAsync(ctx, ct)
activate DBCheck

DBCheck -> ScopeFactory : CreateScope()
activate ScopeFactory
ScopeFactory --> DBCheck : IServiceScope
deactivate ScopeFactory

DBCheck -> DbCtx : Database.CanConnectAsync(ct)
activate DbCtx
DbCtx -> DB : SELECT 1
DB --> DbCtx : OK
DbCtx --> DBCheck : true
deactivate DbCtx

DBCheck --> HCS : HealthCheckResult.Healthy\n{ Duration: ~10ms }
deactivate DBCheck

HCS --> MW : HealthReport\n{ Status: Healthy,\n  TotalDuration: ~10ms,\n  Entries: { database: Healthy } }
deactivate HCS

MW -> MW : ResponseWriter:\nSerialise to JSON
note right of MW
  Custom JSON response writer:
  {
    "status": "Healthy",
    "totalDuration": "00:00:00.0100000",
    "checks": [
      {
        "name": "database",
        "status": "Healthy",
        "description": null,
        "duration": "00:00:00.0098123"
      }
    ]
  }
end note

MW --> HTTP : 200 OK\nContent-Type: application/json
deactivate MW

HTTP --> Hook : { status, checks, totalDuration }
deactivate HTTP

Hook --> HealthPage : { data: healthReport }
deactivate Hook

HealthPage --> User : Green "Healthy" status cards\nfor each check + total duration
deactivate HealthPage

== Auto-Refresh (every 30 s) ==

note over Hook : TanStack Query fires\nrefetchInterval: 30_000

Hook -> HTTP : GET /health/details
HTTP -> MW : ...
MW -> HCS : RunAsync(ct)
HCS -> DBCheck : CheckHealthAsync(ct)
DBCheck -> DbCtx : CanConnectAsync()
DbCtx -> DB : SELECT 1
DB --> DbCtx : OK
DbCtx --> DBCheck : true
DBCheck --> HCS : Healthy
HCS --> MW : HealthReport
MW --> HTTP : 200 OK
HTTP --> Hook : healthReport
Hook --> HealthPage : updated timestamp

== Degraded / Unhealthy Response ==

note over DB : Database goes offline

Hook -> HTTP : GET /health/details (next poll)
HTTP -> MW : request
MW -> HCS : RunAsync(ct)
HCS -> DBCheck : CheckHealthAsync(ct)
DBCheck -> DbCtx : CanConnectAsync()
DbCtx -> DB : connection attempt
DB --[#red]--> DbCtx : Connection refused / timeout
DbCtx --> DBCheck : false
DBCheck --> HCS : HealthCheckResult.Unhealthy\n{ Exception: "Unable to connect" }
HCS --> MW : HealthReport { Status: Unhealthy }
MW --> HTTP : 503 Service Unavailable\n(JSON body with details)

HTTP --> Hook : error / 503
Hook --> HealthPage : { data: { status: "Unhealthy", ... } }
HealthPage --> User : Red "Unhealthy" banner\n+ database check row in red\n+ error description

note bottom
  /health/live  → 200 text "Healthy" (Kubernetes liveness)
  /health/ready → 200 text "Healthy" (Kubernetes readiness)
  /health/details → full JSON for the UI dashboard
end note

@enduml
