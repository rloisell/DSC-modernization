# .github/workflows/build-and-push.yml  —  Ryan Loisell, GitHub Copilot,
# February 2026, AI-assisted.
#
# Builds the DSC API and Frontend container images and pushes them to the
# BC Gov Artifactory Docker registry (be808f-docker-local).
#
# After a successful push the workflow updates the corresponding image tags
# in the tenant-gitops-be808f repository so that ArgoCD can pick up the
# change and deploy without manual intervention.
#
# Pattern mirrors jag-network-tools / tenant-gitops-be808f conventions.
#
# Required GitHub Secrets (set in repo Settings → Secrets → Actions):
#   ARTIFACTORY_USERNAME   BC Gov Artifactory service account username
#   ARTIFACTORY_PASSWORD   BC Gov Artifactory service account password / token
#   GITOPS_TOKEN           GitHub PAT with write access to tenant-gitops-be808f

name: Build and Push

on:
  push:
    branches:
      - main       # → prod_values.yaml  (tag: main-<sha>)
      - test       # → test_values.yaml  (tag: test-<sha>)
      - develop    # → dev_values.yaml   (tag: dev-<sha>)
    tags:
      - "v*"       # semver release tags
  pull_request:
    branches:
      - main
      - develop

# Limit concurrent runs per branch so that rapid pushes don't queue up a
# backlog of outdated builds.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY:  artifacts.developer.gov.bc.ca
  NAMESPACE: be808f-docker-local
  API_IMAGE: dsc-api
  WEB_IMAGE: dsc-frontend
  GITOPS_REPO: bcgov-c/tenant-gitops-be808f

jobs:

  # ── Build & push images ────────────────────────────────────────────────────
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.short_sha }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Short SHA used as the image tag — provides an unambiguous link back
      # to the commit that produced the image.
      - name: Compute image tag
        id: meta
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Log in to Artifactory
        # Only authenticate when we intend to push (not on pull_request events)
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      # ── API image ──────────────────────────────────────────────────────────
      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context:    .
          file:       containerization/Containerfile.api
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ github.ref_name }}

      # ── Frontend image ─────────────────────────────────────────────────────
      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context:    .
          file:       containerization/Containerfile.frontend
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ steps.meta.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ github.ref_name }}

  # ── Update gitops values ───────────────────────────────────────────────────
  # Keeps the GitOps repo in sync by writing the new image tags directly into
  # the per-environment values files.  ArgoCD detects the commit, reconciles,
  # and rolls out the new images with zero manual intervention.
  update-gitops:
    name: Update GitOps Values
    runs-on: ubuntu-latest
    needs: build
    # Only update gitops for real branch pushes, not PRs or version tags
    if: >
      github.event_name == 'push' &&
      contains(fromJson('["main","test","develop"]'), github.ref_name)

    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token:      ${{ secrets.GITOPS_TOKEN }}
          ref:        main   # gitops repo uses a single main branch

      - name: Install yq
        uses: mikefarah/yq@v4

      # Map the app repo branch to the correct gitops values file
      - name: Resolve target values file
        id: env
        run: |
          case "${{ github.ref_name }}" in
            develop) VALUES_FILE="deploy/dsc-dev_values.yaml"   ;;
            test)    VALUES_FILE="deploy/dsc-test_values.yaml"  ;;
            main)    VALUES_FILE="deploy/dsc-prod_values.yaml"  ;;
          esac
          echo "values_file=${VALUES_FILE}" >> "$GITHUB_OUTPUT"

      - name: Update API image tag
        run: |
          yq -i '.api.image.tag = "${{ needs.build.outputs.image_tag }}"' \
            ${{ steps.env.outputs.values_file }}

      - name: Update Frontend image tag
        run: |
          yq -i '.frontend.image.tag = "${{ needs.build.outputs.image_tag }}"' \
            ${{ steps.env.outputs.values_file }}

      - name: Commit and push updated values
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.env.outputs.values_file }}
          git diff --staged --quiet || \
            git commit -m "chore(dsc): bump image tags to ${{ needs.build.outputs.image_tag }} [${{ github.ref_name }}]"
          git push
