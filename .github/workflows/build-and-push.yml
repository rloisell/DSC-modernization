# .github/workflows/build-and-push.yml  —  Ryan Loisell, GitHub Copilot,
# February 2026, AI-assisted.
#
# Builds the DSC API and Frontend container images and pushes them to the
# BC Gov Artifactory Docker registry (be808f-docker-local).
#
# Per EA Option 2 (ISB preferred GitOps pattern for Emerald):
#   develop branch → direct commit to dsc-dev_values.yaml   (ArgoCD auto-sync)
#   test branch    → direct commit to dsc-test_values.yaml  (ArgoCD auto-sync)
#   main branch / v* semver tag → opens a PR to the gitops repo targeting
#     dsc-prod_values.yaml.  A maintainer must approve the PR before ArgoCD
#     syncs to be808f-prod.  Semver tags use the version (e.g. v1.0.1) as the
#     image tag; branches use the short commit SHA.
#
# Required GitHub Secrets (set in repo Settings → Secrets → Actions):
#   ARTIFACTORY_USERNAME   BC Gov Artifactory service account username
#   ARTIFACTORY_PASSWORD   BC Gov Artifactory service account password / token
#   GITOPS_TOKEN           GitHub PAT with repo write access to tenant-gitops-be808f

name: Build and Push

on:
  push:
    branches:
      - main       # → prod PR in gitops repo
      - test       # → direct commit to dsc-test_values.yaml
      - develop    # → direct commit to dsc-dev_values.yaml
    tags:
      - "v*"       # semver release tags → prod PR with version as image tag
  pull_request:
    branches:
      - main
      - develop

# Limit concurrent runs per ref so rapid pushes don't stack stale builds.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY:    artifacts.developer.gov.bc.ca
  NAMESPACE:   be808f-docker-local
  API_IMAGE:   dsc-api
  WEB_IMAGE:   dsc-frontend
  GITOPS_REPO: bcgov-c/tenant-gitops-be808f

jobs:

  # ── Build & push images ────────────────────────────────────────────────────
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Image tag strategy (per ISB EA Option 2 guidance):
      #   v* semver tag  → use the tag name as-is (e.g. v1.0.1)
      #   branch push    → short SHA for per-commit traceability
      - name: Compute image tag
        id: meta
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "image_tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to Artifactory
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      # ── API image ──────────────────────────────────────────────────────────
      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context:    .
          file:       containerization/Containerfile.api
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.API_IMAGE }}:${{ github.ref_name }}

      # ── Frontend image ─────────────────────────────────────────────────────
      - name: Build Frontend image
        uses: docker/build-push-action@v5
        with:
          context:    .
          file:       containerization/Containerfile.frontend
          push:       ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ steps.meta.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.WEB_IMAGE }}:${{ github.ref_name }}

  # ── Update gitops (dev/test) ───────────────────────────────────────────────
  # Direct commit to the gitops repo for develop and test branches.
  # ArgoCD detects the change and auto-syncs to the matching namespace.
  # Prod updates use the create-prod-pr job below instead.
  update-gitops:
    name: Update GitOps Values (dev/test)
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'push' &&
      contains(fromJson('["test","develop"]'), github.ref_name)

    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token:      ${{ secrets.GITOPS_TOKEN }}
          ref:        main

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Resolve target values file
        id: env
        run: |
          case "${{ github.ref_name }}" in
            develop) echo "values_file=deploy/dsc-dev_values.yaml"  >> "$GITHUB_OUTPUT" ;;
            test)    echo "values_file=deploy/dsc-test_values.yaml" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Update API image tag
        run: yq -i '.api.image.tag = "${{ needs.build.outputs.image_tag }}"' ${{ steps.env.outputs.values_file }}

      - name: Update Frontend image tag
        run: yq -i '.frontend.image.tag = "${{ needs.build.outputs.image_tag }}"' ${{ steps.env.outputs.values_file }}

      - name: Commit and push updated values
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ steps.env.outputs.values_file }}
          git diff --staged --quiet || \
            git commit -m "chore(dsc): bump image tags to ${{ needs.build.outputs.image_tag }} [${{ github.ref_name }}]"
          git push

  # ── Create prod PR ─────────────────────────────────────────────────────────
  # Per ISB EA Option 2: production deployments must go through a reviewed PR
  # in the gitops repo — never a direct commit.  A maintainer approves the PR;
  # on merge ArgoCD syncs be808f-prod automatically.
  #
  # Triggered by:
  #   - push to main branch (main-<sha> image tag)
  #   - push of a v* semver tag (e.g. v1.0.1 → image tag v1.0.1)
  create-prod-pr:
    name: Open Prod Deployment PR
    runs-on: ubuntu-latest
    needs: build
    if: >
      github.event_name == 'push' && (
        github.ref_name == 'main' ||
        startsWith(github.ref, 'refs/tags/v')
      )

    steps:
      - name: Checkout gitops repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token:      ${{ secrets.GITOPS_TOKEN }}
          ref:        main

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Create release branch
        id: branch
        run: |
          BRANCH="chore/dsc-prod-${{ needs.build.outputs.image_tag }}"
          git checkout -b "${BRANCH}"
          echo "name=${BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Update prod image tags
        run: |
          yq -i '.api.image.tag      = "${{ needs.build.outputs.image_tag }}"' deploy/dsc-prod_values.yaml
          yq -i '.frontend.image.tag = "${{ needs.build.outputs.image_tag }}"' deploy/dsc-prod_values.yaml

      - name: Commit and push branch
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add deploy/dsc-prod_values.yaml
          git commit -m "chore(dsc): bump prod image tags to ${{ needs.build.outputs.image_tag }}"
          git push origin "${{ steps.branch.outputs.name }}"

      - name: Open pull request
        env:
          GH_TOKEN: ${{ secrets.GITOPS_TOKEN }}
        run: |
          gh pr create \
            --repo "${{ env.GITOPS_REPO }}" \
            --base main \
            --head "${{ steps.branch.outputs.name }}" \
            --title "chore(dsc): promote to prod — ${{ needs.build.outputs.image_tag }}" \
            --body "## DSC Production Deployment

          **Image tag:** \`${{ needs.build.outputs.image_tag }}\`
          **Source commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Triggered by:** \`${{ github.ref_name }}\` on \`${{ github.repository }}\`

          This PR updates \`deploy/dsc-prod_values.yaml\` with the new image tags.
          ArgoCD will sync to \`be808f-prod\` automatically on merge.

          > **Requires maintainer approval before merging.**"
